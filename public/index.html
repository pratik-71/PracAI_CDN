<!DOCTYPE html>
<html>
<head>
    <title>File Upload to S3</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3046c7;
            --success-color: #2ecc71;
            --success-hover: #27ae60;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-color: #dfe6e9;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            text-align: center;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-links a {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .nav-links a:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .upload-form {
            background: var(--card-background);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .select-group {
            margin-bottom: 1.5rem;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .select-group.hidden {
            opacity: 0;
            height: 0;
            margin: 0;
            pointer-events: none;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .folder-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            color: var(--text-primary);
            background-color: white;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
        }

        .folder-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .file-input-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }

        #fileInput {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }

        .preview {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--radius-md);
            background-color: rgba(67, 97, 238, 0.05);
            display: none;
        }

        .preview img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-sm);
        }

        .submit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover:not(:disabled) {
            background-color: var(--success-hover);
            transform: translateY(-1px);
        }

        .submit-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        .loading-spinner {
            margin-left: 0.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .success-modal {
            background: var(--card-background);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            animation: slideIn 0.5s ease-out;
            max-width: 90%;
            width: 400px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            animation: scaleIn 0.5s ease-out;
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        .success-title {
            font-size: 1.75rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .success-message {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .success-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .success-btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .view-btn {
            background: var(--primary-color);
            color: white;
        }

        .view-btn:hover {
            background: var(--primary-hover);
        }

        .upload-another-btn {
            background: var(--success-color);
            color: white;
        }

        .upload-another-btn:hover {
            background: var(--success-hover);
        }

        .error-message {
            display: none;
            color: var(--danger-color);
            background-color: rgba(231, 76, 60, 0.1);
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-top: 1rem;
            border-left: 4px solid var(--danger-color);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .upload-form {
                padding: 1.5rem;
            }

            .success-modal {
                padding: 1.5rem;
            }
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .text-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            color: var(--text-primary);
            background-color: white;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .add-btn {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background-color: var(--primary-hover);
        }

        .file-details {
            margin: 1rem 0;
            padding: 1rem;
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .file-details.hidden {
            display: none;
        }

        .file-info {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .file-name {
            font-weight: 500;
            color: var(--primary-color);
        }

        .rename-group {
            margin-top: 0.5rem;
        }

        .rename-group label {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .file-extension {
            padding: 0.75rem;
            background-color: var(--border-color);
            color: var(--text-secondary);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            font-family: monospace;
        }

        .input-with-button .text-input {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .input-with-button .file-extension {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .progress-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            pointer-events: all;
        }
        .progress-modal.active {
            display: flex;
        }
        .progress-modal-content {
            background: var(--card-background);
            padding: 2rem 2.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            text-align: center;
            min-width: 300px;
        }
        .progress-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem auto;
            animation: spin 1s linear infinite;
        }
        .progress-message {
            font-size: 1.2rem;
            margin-bottom: 0;
            color: var(--text-primary);
        }
        body.progress-blocked {
            overflow: hidden;
            pointer-events: none;
            user-select: none;
        }
        .progress-modal.active {
            pointer-events: all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-links">
            <a href="/">📤 Upload</a>
            <a href="/gallery">🖼️ View Gallery</a>
        </div>
        <h1>Upload File to S3</h1>
        <div class="upload-form">
            <form id="uploadForm" onsubmit="handleSubmit(event)">
                <div class="select-group">
                    <label for="mainFolder">Select Main Folder</label>
                    <select name="mainFolder" id="mainFolder" class="folder-select" required>
                        <option value="">Choose a folder...</option>
                        <option value="webpage">📄 Webpage</option>
                        <option value="game">🎮 Game</option>
                        <option value="new">➕ Add New Folder...</option>
                    </select>
                </div>

                <div class="select-group hidden" id="newMainFolderGroup">
                    <label for="newMainFolder">Enter New Folder Name</label>
                    <div class="input-with-button">
                        <input type="text" id="newMainFolder" class="text-input" placeholder="Enter folder name...">
                        <button type="button" class="add-btn" onclick="addMainFolder()">Add</button>
                    </div>
                </div>

                <div class="select-group hidden" id="subfolderGroup">
                    <label for="subfolder" id="subfolderLabel">Select Subfolder</label>
                    <select name="subfolder" id="subfolder" class="folder-select" required>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>

                <div class="select-group hidden" id="newSubfolderGroup">
                    <label for="newSubfolder">Enter New Subfolder Name</label>
                    <div class="input-with-button">
                        <input type="text" id="newSubfolder" class="text-input" placeholder="Enter subfolder name...">
                        <button type="button" class="add-btn" onclick="addSubfolder()">Add</button>
                    </div>
                </div>

                <div class="file-input-container">
                    <label for="fileInput" class="file-input-label">
                        <div style="text-align: center;">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <div style="margin-top: 0.5rem;">
                                Click to select a file or drag and drop
                            </div>
                        </div>
                    </label>
                    <input type="file" id="fileInput" name="file" required>
                </div>

                <div id="fileDetails" class="file-details hidden">
                    <div class="file-info">
                        <span>Selected file: </span>
                        <span id="fileName" class="file-name"></span>
                    </div>
                    <div class="rename-group">
                        <label for="newFileName">Rename file (optional):</label>
                        <div class="input-with-button">
                            <input type="text" id="newFileName" class="text-input" placeholder="Enter new file name">
                            <span id="fileExtension" class="file-extension"></span>
                        </div>
                    </div>
                </div>

                <div id="preview" class="preview">
                    <img id="imagePreview" style="display: none;">
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    Upload to S3
                    <span class="loading-spinner">↻</span>
                </button>
                <div class="error-message" id="errorMessage"></div>
            </form>
        </div>
    </div>

    <div class="success-overlay" id="successOverlay">
        <div class="success-modal">
            <div class="success-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                </svg>
            </div>
            <h2 class="success-title">Upload Successful!</h2>
            <p class="success-message">Your file has been successfully uploaded to S3.</p>
            <div class="success-buttons">
                <button class="success-btn view-btn" onclick="window.location.href='/gallery'">View in Gallery</button>
                <button class="success-btn upload-another-btn" onclick="resetForm()">Upload Another</button>
            </div>
        </div>
    </div>

    <div class="progress-modal" id="progressModal">
        <div class="progress-modal-content">
            <div class="progress-spinner"></div>
            <div class="progress-message" id="progressMessage">Uploading...</div>
        </div>
    </div>

    <script>
        // Default folders and subfolders
        const defaultFolders = {
            webpage: [
                { value: 'about', label: 'About' },
                { value: 'home', label: 'Home' },
                { value: 'auth', label: 'Auth' },
                { value: 'misc', label: 'Misc' }
            ],
            game: [
                { value: 'week1', label: 'Week 1' },
                { value: 'week2', label: 'Week 2' },
                { value: 'week3', label: 'Week 3' },
                { value: 'week4', label: 'Week 4' }
            ]
        };
        let subfolders = { ...defaultFolders };

        // Fetch folders from backend and merge with defaults
        async function fetchFolders() {
            try {
                const res = await fetch('/api/folders');
                if (!res.ok) throw new Error('Failed to fetch folders');
                const data = await res.json();
                // Merge with defaultFolders for label formatting
                for (const main in data) {
                    if (!subfolders[main]) subfolders[main] = [];
                    data[main].forEach(sub => {
                        if (!subfolders[main].some(f => f.value === sub)) {
                            subfolders[main].push({ value: sub, label: sub.charAt(0).toUpperCase() + sub.slice(1) });
                        }
                    });
                }
                updateMainFolderDropdown();
            } catch (e) {
                updateMainFolderDropdown(); // fallback to defaults
            }
        }

        // Update main folder dropdown
        function updateMainFolderDropdown() {
            const mainFolderSelect = document.getElementById('mainFolder');
            // Save current value
            const current = mainFolderSelect.value;
            // Remove all except the first option and 'Add New'
            mainFolderSelect.innerHTML = '<option value="">Choose a folder...</option>';
            for (const main in subfolders) {
                const label = main.charAt(0).toUpperCase() + main.slice(1);
                const option = document.createElement('option');
                option.value = main;
                option.textContent = (main === 'webpage' ? '📄 ' : main === 'game' ? '🎮 ' : '📁 ') + label;
                mainFolderSelect.appendChild(option);
            }
            // Add New option
            const newOpt = document.createElement('option');
            newOpt.value = 'new';
            newOpt.textContent = '➕ Add New Folder...';
            mainFolderSelect.appendChild(newOpt);
            // Restore value if possible
            if ([...mainFolderSelect.options].some(o => o.value === current)) {
                mainFolderSelect.value = current;
            }
        }

        // Update subfolder dropdown
        function updateSubfolderDropdown(main) {
            const subfolderSelect = document.getElementById('subfolder');
            subfolderSelect.innerHTML = '<option value="">Choose a subfolder...</option>';
            if (subfolders[main]) {
                subfolders[main].forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.label;
                    subfolderSelect.appendChild(opt);
                });
            }
            // Add New option
            const newOpt = document.createElement('option');
            newOpt.value = 'new';
            newOpt.textContent = '➕ Add New Subfolder...';
            subfolderSelect.appendChild(newOpt);
        }

        // On page load, fetch folders
        window.addEventListener('DOMContentLoaded', fetchFolders);

        document.getElementById('mainFolder').addEventListener('change', function(e) {
            const newMainFolderGroup = document.getElementById('newMainFolderGroup');
            const subfolderGroup = document.getElementById('subfolderGroup');
            const subfolderLabel = document.getElementById('subfolderLabel');
            const newSubfolderGroup = document.getElementById('newSubfolderGroup');
            newMainFolderGroup.classList.add('hidden');
            subfolderGroup.classList.add('hidden');
            newSubfolderGroup.classList.add('hidden');
            if (this.value === 'new') {
                newMainFolderGroup.classList.remove('hidden');
                return;
            }
            if (this.value) {
                updateSubfolderDropdown(this.value);
                subfolderLabel.textContent = `Select ${this.value === 'webpage' ? 'Webpage' : this.value === 'game' ? 'Game' : this.value.charAt(0).toUpperCase() + this.value.slice(1)} Subfolder`;
                subfolderGroup.classList.remove('hidden');
            }
        });

        document.getElementById('subfolder').addEventListener('change', function(e) {
            const newSubfolderGroup = document.getElementById('newSubfolderGroup');
            if (this.value === 'new') {
                newSubfolderGroup.classList.remove('hidden');
                this.selectedIndex = 0;
            } else {
                newSubfolderGroup.classList.add('hidden');
            }
        });

        function addMainFolder() {
            const newMainFolderInput = document.getElementById('newMainFolder');
            const mainFolderSelect = document.getElementById('mainFolder');
            const newMainFolderGroup = document.getElementById('newMainFolderGroup');
            const folderName = newMainFolderInput.value.trim().toLowerCase();
            if (!folderName) {
                showError('Please enter a folder name');
                return;
            }
            if (subfolders[folderName]) {
                showError('This folder already exists');
                return;
            }
            subfolders[folderName] = [];
            const option = document.createElement('option');
            option.value = folderName;
            option.textContent = `📁 ${folderName.charAt(0).toUpperCase() + folderName.slice(1)}`;
            mainFolderSelect.insertBefore(option, mainFolderSelect.lastElementChild);
            mainFolderSelect.value = folderName;
            newMainFolderInput.value = '';
            newMainFolderGroup.classList.add('hidden');
            mainFolderSelect.dispatchEvent(new Event('change'));
        }

        function addSubfolder() {
            const newSubfolderInput = document.getElementById('newSubfolder');
            const mainFolder = document.getElementById('mainFolder').value;
            const subfolderSelect = document.getElementById('subfolder');
            const newSubfolderGroup = document.getElementById('newSubfolderGroup');
            const folderName = newSubfolderInput.value.trim().toLowerCase();
            if (!folderName) {
                showError('Please enter a subfolder name');
                return;
            }
            if (subfolders[mainFolder].some(f => f.value === folderName)) {
                showError('This subfolder already exists');
                return;
            }
            subfolders[mainFolder].push({
                value: folderName,
                label: folderName.charAt(0).toUpperCase() + folderName.slice(1)
            });
            const option = document.createElement('option');
            option.value = folderName;
            option.textContent = folderName.charAt(0).toUpperCase() + folderName.slice(1);
            subfolderSelect.insertBefore(option, subfolderSelect.lastElementChild);
            subfolderSelect.value = folderName;
            newSubfolderInput.value = '';
            newSubfolderGroup.classList.add('hidden');
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        }

        // Add drag and drop functionality
        const dropZone = document.querySelector('.file-input-label');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.style.borderColor = 'var(--primary-color)';
            dropZone.style.backgroundColor = 'rgba(67, 97, 238, 0.05)';
        }

        function unhighlight(e) {
            dropZone.style.borderColor = 'var(--border-color)';
            dropZone.style.backgroundColor = 'transparent';
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('fileInput').files = files;
            handleFileSelect(files[0]);
        }

        // Add image preview functionality
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            const preview = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('preview');
            const fileDetails = document.getElementById('fileDetails');
            const fileName = document.getElementById('fileName');
            const newFileName = document.getElementById('newFileName');
            const fileExtension = document.getElementById('fileExtension');
            
            if (file) {
                // Show file details
                fileName.textContent = file.name;
                const extension = file.name.split('.').pop();
                fileExtension.textContent = '.' + extension;
                
                // Set placeholder for new name (original name without extension)
                const nameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.'));
                newFileName.placeholder = nameWithoutExt;
                newFileName.value = ''; // Clear any previous value
                
                fileDetails.classList.remove('hidden');
                
                // Handle image preview if it's an image
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        previewContainer.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                    previewContainer.style.display = 'none';
                }
            } else {
                fileDetails.classList.add('hidden');
                preview.style.display = 'none';
                previewContainer.style.display = 'none';
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const spinner = document.querySelector('.loading-spinner');
            const errorMessage = document.getElementById('errorMessage');
            const fileInput = document.getElementById('fileInput');
            const newFileName = document.getElementById('newFileName');
            const progressModal = document.getElementById('progressModal');
            const progressMessage = document.getElementById('progressMessage');
            
            submitBtn.disabled = true;
            spinner.style.display = 'inline-block';
            errorMessage.style.display = 'none';

            // Show progress modal and block UI
            progressModal.classList.add('active');
            document.body.classList.add('progress-blocked');
            progressMessage.textContent = 'Uploading...';

            try {
                const formData = new FormData(event.target);
                const file = fileInput.files[0];
                
                // Handle file renaming
                if (newFileName.value.trim()) {
                    const extension = file.name.split('.').pop();
                    const newFile = new File([file], `${newFileName.value.trim()}.${extension}`, {
                        type: file.type
                    });
                    formData.set('file', newFile);
                }

                // Use XMLHttpRequest for progress
                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/upload');

                    xhr.onload = function () {
                        let result = {};
                        try {
                            result = JSON.parse(xhr.responseText);
                        } catch (err) {}
                        if (xhr.status >= 200 && xhr.status < 300) {
                            progressMessage.textContent = 'Upload complete!';
                            setTimeout(() => {
                                progressModal.classList.remove('active');
                                document.body.classList.remove('progress-blocked');
                                showSuccessOverlay();
                                resolve();
                            }, 500);
                        } else {
                            progressModal.classList.remove('active');
                            document.body.classList.remove('progress-blocked');
                            errorMessage.textContent = result.details || result.error || 'Upload failed. Please try again.';
                            errorMessage.style.display = 'block';
                            resolve();
                        }
                    };

                    xhr.onerror = function () {
                        progressModal.classList.remove('active');
                        document.body.classList.remove('progress-blocked');
                        errorMessage.textContent = 'Network error. Please try again.';
                        errorMessage.style.display = 'block';
                        resolve();
                    };

                    xhr.send(formData);
                });
            } catch (error) {
                progressModal.classList.remove('active');
                document.body.classList.remove('progress-blocked');
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function showSuccessOverlay() {
            const overlay = document.getElementById('successOverlay');
            overlay.style.display = 'flex';
        }

        function resetForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('successOverlay').style.display = 'none';
            document.getElementById('preview').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('fileDetails').classList.add('hidden');
            document.getElementById('subfolderGroup').classList.add('hidden');
        }
    </script>
</body>
</html> 